"use strict";(()=>{var t={};t.id=746,t.ids=[746],t.modules={5600:t=>{t.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3873:t=>{t.exports=require("path")},6762:(t,e)=>{Object.defineProperty(e,"M",{enumerable:!0,get:function(){return function t(e,i){return i in e?e[i]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,i)):"function"==typeof e&&"default"===i?e:void 0}}})},6798:(t,e,i)=>{i.r(e),i.d(e,{config:()=>S,default:()=>A,routeModule:()=>T});var r={};i.r(r),i.d(r,{config:()=>y,middleware:()=>m});var s=i(9947),o=i(2706),n=i(6762);let a=require("@supabase/auth-helpers-nextjs"),l=require("next/server");var h=i(3873),g=i.n(h);let d=require("fs/promises");var c=i.n(d);let u=require("node-fetch");var p=i.n(u);class w{constructor(){this.testMode=!1,this.errorCounts=[],this.ALERT_THRESHOLD=5,this.ALERT_WINDOW=6e4,this.pendingWrites=[],this.initialized=!1,this.logContent={},this.errorState={errors:[],lastAlert:0},this.rotatedFiles=[],this.shouldSimulateError=!1,this.errorWindowMs=6e4,this.recentErrors=[],this.logDir=g().join(process.cwd(),"logs"),this.context={},this.lastAlertTime=0,this.logApiUrl=process.env.LOG_API_URL||"http://localhost:3001/api/logs",this.maxFileSize=1048576}static getInstance(){return w.instance||(w.instance=new w),w.instance}async ensureInitialized(){if(!this.initialized){await c().mkdir(this.logDir,{recursive:!0});let t=g().join(this.logDir,"app.log"),e=g().join(this.logDir,"error.log");this.logContent[t]="",this.logContent[e]="",await c().writeFile(t,""),await c().writeFile(e,""),this.initialized=!0}}async setTestMode(t){if(this.testMode=t,this.initialized=!1,this.logContent={},this.errorCounts=[],this.rotatedFiles=[],this.pendingWrites=[],this.shouldSimulateError=!1,this.lastAlertTime=0,t){this.logDir=g().join(process.cwd(),"test-logs"),await c().mkdir(this.logDir,{recursive:!0});let t=g().join(this.logDir,"app.log"),e=g().join(this.logDir,"error.log");this.logContent[t]="",this.logContent[e]="",await c().writeFile(t,""),await c().writeFile(e,"")}else this.logDir=g().join(process.cwd(),"logs");this.initialized=!0}async handleWrite(t,e){if(this.testMode){if(this.shouldSimulateError)throw Error("Simulated file system error in test mode");this.logContent[e]=this.logContent[e]||"",this.logContent[e]+=JSON.stringify(t)+"\n";return}}async writeToFile(t,e){await this.ensureInitialized(),this.testMode&&!this.logContent[t]&&(this.logContent[t]="");try{(this.testMode?Buffer.from(this.logContent[t]||"").length:(await c().stat(t)).size)>=this.maxFileSize&&await this.rotateLogFile(t),this.testMode?this.logContent[t]=(this.logContent[t]||"")+e+"\n":await c().appendFile(t,e+"\n"),t.endsWith("error.log")&&e.includes('"level":"error"')&&await this.checkErrorThreshold()}catch(t){throw this.testMode,t}}async rotateLogFile(t){try{let e=new Date().toISOString().replace(/[:.]/g,"-"),i=`${t}.${e}`;this.testMode?(this.logContent[i]=this.logContent[t]||"",this.logContent[t]=""):(await c().copyFile(t,i),await c().writeFile(t,"")),this.rotatedFiles.includes(i)||this.rotatedFiles.push(i)}catch(t){throw this.testMode,t}}async checkErrorThreshold(){let t=Date.now();if(this.errorCounts=this.errorCounts.filter(e=>t-e.timestamp<this.ALERT_WINDOW),this.errorCounts.push({timestamp:t}),this.errorCounts.length>=this.ALERT_THRESHOLD&&(t-this.lastAlertTime>=this.ALERT_WINDOW||!this.lastAlertTime)){let e={timestamp:new Date().toISOString(),type:"alert",level:"error",message:`Error threshold exceeded: ${this.errorCounts.length} errors in ${this.ALERT_WINDOW/1e3}s`,count:this.errorCounts.length,window:this.ALERT_WINDOW},i=g().join(this.logDir,"error.log");await this.writeToFile(i,JSON.stringify(e)),this.lastAlertTime=t,this.errorCounts=[]}}async info(t,e={}){await this.ensureInitialized();let i={timestamp:new Date().toISOString(),level:"info",type:"log",message:t,...this.context,...e};try{let e=g().join(this.logDir,"app.log");await this.writeToFile(e,JSON.stringify(i)),this.testMode||await this.sendToLogApi("info",t,i)}catch(t){throw this.testMode,t}}async warn(t,e={}){await this.ensureInitialized();let i={timestamp:new Date().toISOString(),level:"warn",type:"log",message:t,...this.context,...e};try{let e=g().join(this.logDir,"app.log");await this.writeToFile(e,JSON.stringify(i)),this.testMode||await this.sendToLogApi("warn",t,i)}catch(t){throw this.testMode,t}}async debug(t,e={}){await this.ensureInitialized();let i={timestamp:new Date().toISOString(),level:"debug",type:"log",message:t,...this.context,...e};try{let e=g().join(this.logDir,"app.log");await this.writeToFile(e,JSON.stringify(i)),this.testMode||await this.sendToLogApi("debug",t,i)}catch(t){throw this.testMode,t}}async error(t,e){await this.ensureInitialized(),await this.checkErrorThreshold();let i={timestamp:new Date().toISOString(),level:"error",type:"error",message:t,error:e?{message:e.message,stack:e.stack}:void 0,...this.context};try{let e=g().join(this.logDir,"error.log");await this.writeToFile(e,JSON.stringify(i)),this.testMode||await this.sendToLogApi("error",t,i)}catch(t){throw this.testMode,t}}async logPerformance(t,e,i={}){let r={timestamp:new Date().toISOString(),type:"performance",operation:t,duration:e,...this.context,...i};await this.writeToFile(g().join(this.logDir,"app.log"),JSON.stringify(r)),this.testMode||await this.sendToLogApi("info",`Performance: ${t}`,r,"performance")}async waitForWrites(){try{await Promise.all(this.pendingWrites)}finally{this.pendingWrites=[]}}async sendToLogApi(t,e,i,r="log"){if(!this.testMode)try{let s=await p()(this.logApiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({level:t,message:e,data:i,type:r,timestamp:new Date().toISOString()})});if(!s.ok)throw Error(`Failed to send log to API: ${s.statusText}`)}catch(t){console.error("Error sending log to API:",t)}}setContext(t){this.context={...this.context,...t}}clearContext(){this.context={}}clearErrorCount(){this.recentErrors=[]}getLogContent(){return this.logContent}getLogDir(){return this.logDir}getLogPath(){return g().join(this.logDir,"error.log")}getRotatedFiles(){return this.rotatedFiles}}let f=w.getInstance();async function m(t){try{let e=l.NextResponse.next(),i=(0,a.createMiddlewareClient)({req:t,res:e}),{data:{session:r}}=await i.auth.getSession();if(r?.expires_at&&r.expires_at<Math.floor(Date.now()/1e3)){let{error:t}=await i.auth.refreshSession();if(t)throw f.error(t.message),t;f.info("Session refreshed successfully")}return e}catch(e){return f.error(e.message),l.NextResponse.redirect(new URL("/auth/login",t.url))}}let y={matcher:["/((?!_next/static|_next/image|favicon.ico|public|auth).*)"]},A=(0,n.M)(r,"default"),S=(0,n.M)(r,"config"),T=new s.PagesAPIRouteModule({definition:{kind:o.A.PAGES_API,page:"/api/auth/[...supabase]",pathname:"/api/auth/[...supabase]",bundlePath:"",filename:""},userland:r})},2706:(t,e)=>{Object.defineProperty(e,"A",{enumerable:!0,get:function(){return i}});var i=function(t){return t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE",t.IMAGE="IMAGE",t}({})},9947:(t,e,i)=>{t.exports=i(5600)}};var e=require("../../../webpack-api-runtime.js");e.C(t);var i=e(e.s=6798);module.exports=i})();