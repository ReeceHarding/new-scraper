"use strict";(()=>{var t={};t.id=746,t.ids=[746],t.modules={5600:t=>{t.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9021:t=>{t.exports=require("fs")},3873:t=>{t.exports=require("path")},6762:(t,e)=>{Object.defineProperty(e,"M",{enumerable:!0,get:function(){return function t(e,i){return i in e?e[i]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,i)):"function"==typeof e&&"default"===i?e:void 0}}})},6798:(t,e,i)=>{i.r(e),i.d(e,{config:()=>E,default:()=>y,routeModule:()=>P});var r={};i.r(r),i.d(r,{config:()=>A,middleware:()=>S});var s=i(9947),o=i(2706),n=i(6762);let a=require("@supabase/auth-helpers-nextjs"),l=require("next/server");var h=i(3873),g=i.n(h);let d=require("fs/promises");var c=i.n(d),p=i(9021),m=i.n(p);let u=require("node-fetch");var w=i.n(u);class f{constructor(){this.testMode=!1,this.errorCounts=[],this.ALERT_THRESHOLD=5,this.ALERT_WINDOW=6e4,this.testAlertWindow=6e4,this.pendingWrites=[],this.initialized=!1,this.logContent={},this.errorState={errors:[],lastAlert:0},this.rotatedFiles=[],this.shouldSimulateError=!1,this.errorWindowMs=6e4,this.recentErrors=[],this.isProcessingAlert=!1,this.errorThreshold=5,this.errorThresholdWindow=6e4,this.apiEndpoint="http://localhost:3001/api/logs",this.errorTimestamps=[],this.logDir=g().join(process.cwd(),this.testMode?"test-logs":"logs"),this.context={},this.lastAlertTime=0,this.logApiUrl=process.env.LOG_API_URL||"http://localhost:3001/api/logs",this.maxFileSize=1048576}static getInstance(){return f.instance||(f.instance=new f),f.instance}async ensureInitialized(){if(!this.initialized){await c().mkdir(this.logDir,{recursive:!0});let t=g().join(this.logDir,"app.log"),e=g().join(this.logDir,"error.log");if(this.testMode)this.logContent={[t]:"",[e]:""},this.initialized=!0;else{try{await c().access(t)}catch{await c().writeFile(t,"")}try{await c().access(e)}catch{await c().writeFile(e,"")}this.initialized=!0}}}async addPendingWrite(t){let e=t.finally(()=>{this.pendingWrites=this.pendingWrites.filter(t=>t!==e)});this.pendingWrites.push(e),await e}async setTestMode(t){if(await this.waitForWrites(),this.testMode=t,this.initialized=!1,this.logContent={},this.errorCounts=[],this.rotatedFiles=[],this.lastAlertTime=0,this.isProcessingAlert=!1,this.shouldSimulateError=!1,this.context={},this.pendingWrites=[],this.errorTimestamps=[],t){this.logDir=g().join(process.cwd(),"test-logs"),this.maxFileSize=100,this.errorThreshold=5,this.errorThresholdWindow=6e4,this.testAlertWindow=0;try{await c().mkdir(this.logDir,{recursive:!0})}catch{}let t=g().join(this.logDir,"app.log"),e=g().join(this.logDir,"error.log");this.logContent={[t]:"",[e]:""},this.initialized=!0}else this.logDir=g().join(process.cwd(),"logs"),this.maxFileSize=1048576,this.testAlertWindow=6e4,await this.ensureInitialized()}async simulateError(t){await this.waitForWrites(),this.shouldSimulateError=t}async writeToFile(t,e){if(await this.ensureInitialized(),this.shouldSimulateError)throw Error("Simulated error in test mode");let{timestamp:i,...r}=t,s={timestamp:new Date().toISOString(),...this.context,...r},o=JSON.stringify(s)+"\n";try{if(this.testMode){let e=g().join(this.logDir,"app.log"),i=g().join(this.logDir,"error.log");this.logContent[e]||(this.logContent[e]=""),this.logContent[i]||(this.logContent[i]="");let r="error"===t.level||"alert"===t.type?i:e;if(this.logContent[r]+=o,this.logContent[r].length>this.maxFileSize&&(await this.rotateLogFile(r),this.logContent[r]+=o),"error"===t.level&&!t._isAdditionalError){let t=Date.now();if(this.errorTimestamps.push(t),this.errorTimestamps=this.errorTimestamps.filter(e=>t-e<this.errorThresholdWindow),this.errorTimestamps.length>=this.errorThreshold&&!this.isProcessingAlert){this.isProcessingAlert=!0;try{let t={timestamp:new Date().toISOString(),level:"alert",type:"alert",message:`Error threshold exceeded: ${this.errorTimestamps.length} errors in ${this.errorThresholdWindow}ms`,count:this.errorTimestamps.length,window:this.errorThresholdWindow};await this.writeToFile(t,i)}finally{this.isProcessingAlert=!1}}}}else{let t;try{t=await c().stat(e)}catch(i){if("ENOENT"===i.code)await c().writeFile(e,""),t=await c().stat(e);else throw i}if(t.size>this.maxFileSize&&await this.rotateLogFile(e),await c().appendFile(e,o),this.logApiUrl&&!this.testMode)try{await this.sendToLogApi(s)}catch(t){console.error("Error sending log to API:",t)}}}catch(t){if(t instanceof Error&&(this.shouldSimulateError||"Simulated rotation error in test mode"===t.message))throw t;throw console.error("Error writing to log file:",t),t}}async rotateLogFile(t){try{if(this.testMode){let e=new Date().toISOString().replace(/[:.]/g,"-"),i=`${t}.${e}`;this.logContent[i]=this.logContent[t],this.logContent[t]="",this.rotatedFiles.includes(i)||this.rotatedFiles.push(i)}else{let e=new Date().toISOString().replace(/[:.]/g,"-"),i=`${t}.${e}`;await c().rename(t,i),await c().writeFile(t,""),this.rotatedFiles.includes(i)||this.rotatedFiles.push(i)}}catch(t){if(this.testMode&&this.shouldSimulateError)throw Error("Simulated rotation error in test mode");console.error("Error rotating log file:",t)}}async checkErrorThreshold(){let t=Date.now(),e=t-this.errorThresholdWindow;if(this.errorTimestamps=this.errorTimestamps.filter(t=>t>e),this.errorTimestamps.length>=this.errorThreshold&&t-this.lastAlertTime>(this.testMode?0:this.ALERT_WINDOW)){if(this.isProcessingAlert)return;this.isProcessingAlert=!0;try{let e={timestamp:new Date().toISOString(),level:"alert",type:"alert",message:`Error threshold exceeded: ${this.errorTimestamps.length} errors in the last ${this.errorThresholdWindow/1e3} seconds`,count:this.errorTimestamps.length,window:this.errorThresholdWindow},i=g().join(this.logDir,"error.log");await this.writeToFile(e,i),this.lastAlertTime=t,this.testMode||(this.errorTimestamps=[])}finally{this.isProcessingAlert=!1}}}async error(t,e,i={}){let r=Date.now(),s={timestamp:new Date().toISOString(),level:"error",type:"error",message:t,...i};e instanceof Error?s.error={name:e.name,message:e.message,stack:e.stack}:e&&(s.error={name:"UnknownError",message:String(e),originalError:e});let o=g().join(this.logDir,"error.log");i._isAdditionalError||this.errorTimestamps.push(r),await this.writeToFile(s,o),this.testMode&&i._testThreshold?await this.checkErrorThreshold():this.testMode||await this.checkErrorThreshold()}async info(t,e={}){let i={timestamp:new Date().toISOString(),level:"info",type:"info",message:t,...e},r=g().join(this.logDir,"app.log");await this.writeToFile(i,r)}async warn(t,e={}){let i={timestamp:new Date().toISOString(),level:"warn",type:"warning",message:t,...e},r=g().join(this.logDir,"app.log");await this.writeToFile(i,r)}async debug(t,e={}){let i={timestamp:new Date().toISOString(),level:"debug",type:"debug",message:t,...e},r=g().join(this.logDir,"app.log");await this.writeToFile(i,r)}async logPerformance(t,e,i={}){let r={timestamp:new Date().toISOString(),level:"info",type:"performance",message:`Performance monitoring: ${t} took ${e}ms`,operation:t,duration:e,...i},s=g().join(this.logDir,"app.log");await this.writeToFile(r,s)}async performance(t,e,i={}){return this.logPerformance(t,e,i)}async waitForWrites(){await Promise.all(this.pendingWrites)}async sendToLogApi(t){if(!this.testMode&&this.logApiUrl)try{let e=await w()(this.logApiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw Error(`Failed to send log to API: ${e.statusText}`)}catch(t){console.error("Error sending log to API:",t)}}setContext(t){this.context=t}clearContext(){this.context={}}clearErrorCount(){this.errorCounts=[],this.lastAlertTime=0}getLogContent(){return{...this.logContent}}getLogDir(){return this.logDir}getLogPath(){return g().join(this.logDir,"app.log")}getRotatedFiles(){return this.rotatedFiles}clearLogContent(){this.logContent={};let t=g().join(this.logDir,"app.log"),e=g().join(this.logDir,"error.log");this.testMode&&(this.logContent={[t]:"",[e]:""},m().writeFileSync(t,""),m().writeFileSync(e,""))}enableErrorSimulation(){this.shouldSimulateError=!0}disableErrorSimulation(){this.shouldSimulateError=!1}}let T=f.getInstance();async function S(t){try{let e=l.NextResponse.next(),i=(0,a.createMiddlewareClient)({req:t,res:e}),{data:{session:r}}=await i.auth.getSession();if(r?.expires_at&&r.expires_at<Math.floor(Date.now()/1e3)){let{error:t}=await i.auth.refreshSession();if(t)throw T.error(t.message),t;T.info("Session refreshed successfully")}return e}catch(e){return T.error(e.message),l.NextResponse.redirect(new URL("/auth/login",t.url))}}let A={matcher:["/((?!_next/static|_next/image|favicon.ico|public|auth).*)"]},y=(0,n.M)(r,"default"),E=(0,n.M)(r,"config"),P=new s.PagesAPIRouteModule({definition:{kind:o.A.PAGES_API,page:"/api/auth/[...supabase]",pathname:"/api/auth/[...supabase]",bundlePath:"",filename:""},userland:r})},2706:(t,e)=>{Object.defineProperty(e,"A",{enumerable:!0,get:function(){return i}});var i=function(t){return t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE",t.IMAGE="IMAGE",t}({})},9947:(t,e,i)=>{t.exports=i(5600)}};var e=require("../../../webpack-api-runtime.js");e.C(t);var i=e(e.s=6798);module.exports=i})();